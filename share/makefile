# --------------------------------------------------------------------------
# ---  WHY3 Makefile
# --------------------------------------------------------------------------

#WHY3_PACKAGE= name
#WHY3_DEPENDS= pkg ...
#WHY3_EXTRACT= m.M ...
#WHY3_LIBRARIES= ocaml pkg ...
#WHY3_OPTIONS= OPTIONS...
#WHY3_HAMMER= OPTIONS...

# --------------------------------------------------------------------------

.PHONY: all

all: build

# --------------------------------------------------------------------------
# ---  Targets
# --------------------------------------------------------------------------

WHY3_TARGETS=$(shell find $(WHY3_PACKAGE) -name "*.mlw")

.PHONY: compile check replay fix

compile: $(patsubst %.mlw,%.cc,$(WHY3_TARGETS))

replay: $(patsubst %.mlw,%.replay,$(WHY3_TARGETS))
	@echo "-----------------------------"

check: $(patsubst %.mlw,%.check,$(WHY3_TARGETS))

prove: $(patsubst %.mlw,%.prove,$(WHY3_TARGETS))

fix: $(patsubst %.mlw,%.fix,$(WHY3_TARGETS))
	@echo "-----------------------------"

clean:: $(pathsubst %.mlw,%.cleandir,$(WHY3_TARGETS))
	dune clean

# --------------------------------------------------------------------------
# ---  Patterns
# --------------------------------------------------------------------------

WHY3_PKGS=$(addprefix "-p ",$(WHY3_DEPENDS))
WHY3_CCP=why3find compile $(WHY3_OPTIONS) $(WHY3_PKGS)
WHY3_IDE=why3find ide $(WHY3_OPTIONS) $(WHY3_PKGS)
WHY3_REPLAY=why3find replay -f $(WHY3_OPTIONS) $(WHY3_PKGS)
WHY3_PROVE=why3find hammer -u $(WHY3_HAMMER) $(WHY3_PKGS)

%.dir: %.mlw
	@mkdir -p $*

%.cleandir: %.mlw
	@rm -fr $*

%.cc: %.mlw
	@echo "> why3find compile [...] $<"
	@($(WHY3_CCP) $<)

%.chk: %.mlw
	@($(WHY3_CCP) $<)

%.ide: %.chk %.dir
	@echo "> why3find ide $*.mlw, waiting…"
	@($(WHY3_IDE) $*.mlw)

%.prove: %.dir
	@echo "> why3find hammer -u $*.mlw"
	@($(WHY3_PROVE) $*.mlw)

%.fix: %.dir
	@echo "-----------------------------"
	@echo "--- fixup $*"
	@echo "-----------------------------"
	@$(WHY3_PROVE) $*.mlw | tee .log
	@if grep -q "\(failed\|not proved\)" .log ;\
	 then echo "[Fix Required] why3 ide $*, waiting…"; $(WHY3_IDE) $*.mlw; fi

%.check: %.dir
	@echo "--- check $*"
	@$(WHY3_REPLAY) --obsolete-only $* > .log 2> /dev/null
	@if grep -q "\(failed\|not proved\)" .log ;\
	 then cat .log ; exit 1;\
	 fi

%.replay: %.dir
	@echo "-----------------------------"
	@echo "--- replay $*"
	@echo "-----------------------------"
	@$(WHY3_REPLAY) $* | tee .log
	@if grep -q "\(failed\|not proved\)" .log ; then exit 1; fi

# --------------------------------------------------------------------------
# ---  Extraction
# --------------------------------------------------------------------------

.PHONY: extract

WHY3_LIBS=$(shell why3find query -l $(WHY3_DEPENDS))

ifneq ($(WHY3_EXTRACT),)
extract:
	@echo "> why3find extract -o ./lib [...]"
	@rm -f lib/*.ml
	@mkdir -p lib
	@why3find extract --driver ocaml64 --modular -o ./lib \
		$(WHY3_OPTIONS) $(WHY3_PKGS) $(WHY3_EXTRACT)
endif

# --------------------------------------------------------------------------
# ---  Build
# --------------------------------------------------------------------------

.PHONY: build

ifneq ($(WHY3_EXTRACT),)
build:lib/dune
lib/dune: Makefile
	@mkdir -p lib
	@rm -f $@
	@echo "; generated by why3find makefile" > $@
	@echo "(library" >> $@
	@echo "  (name foo)" >> $@
	@echo "  (public_name $(WHY3_PACKAGE))" >> $@
	@echo "  (wrapped false)" >> $@
	@echo "  (libraries $(WHY3_LIBRARIES) $(WHY3_LIBS)))" >> $@
	@chmod a-w $@
	@echo "install (dune)   lib/dune"
endif

build: dune META.json
dune META.json: Makefile
	@rm -f dune META.json
	@why3find install --local \
		$(WHY3_PACKAGE) $(WHY3_DEPENDS) $(WHY3_TARGETS)
	@chmod a-w dune META.json


build:
	@dune build

# --------------------------------------------------------------------------
# ---  INSTALL
# --------------------------------------------------------------------------

.PHONY: install

install::
	@dune install

uninstall::
	@dune uninstall

# --------------------------------------------------------------------------
